name: Health Check & Monitoring

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: lazysheeps-cluster

jobs:
  health-check:
    name: Check Application Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      
      - name: Check pod status
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n lazysheeps
          
          # Check if any pods are not running
          NOT_RUNNING=$(kubectl get pods -n lazysheeps --field-selector=status.phase!=Running -o name | wc -l)
          if [ $NOT_RUNNING -gt 0 ]; then
            echo "Warning: $NOT_RUNNING pods are not running"
            kubectl get pods -n lazysheeps --field-selector=status.phase!=Running
          fi
      
      - name: Check pod restarts
        run: |
          echo "=== Pods with restarts ==="
          kubectl get pods -n lazysheeps -o json | \
            jq -r '.items[] | select(.status.containerStatuses[]?.restartCount > 0) | "\(.metadata.name): \(.status.containerStatuses[].restartCount) restarts"'
      
      - name: Check resource usage
        run: |
          echo "=== Resource Usage ==="
          kubectl top pods -n lazysheeps || echo "Metrics server not available"
      
      - name: Check HPA status
        run: |
          echo "=== HPA Status ==="
          kubectl get hpa -n lazysheeps
      
      - name: Check ingress status
        run: |
          echo "=== Ingress Status ==="
          kubectl get ingress -n lazysheeps
          
          INGRESS_URL=$(kubectl get ingress lazysheeps-ingress -n lazysheeps -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "Application URL: http://$INGRESS_URL"
      
      - name: Test application endpoint
        run: |
          INGRESS_URL=$(kubectl get ingress lazysheeps-ingress -n lazysheeps -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ ! -z "$INGRESS_URL" ]; then
            curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" "http://$INGRESS_URL" || echo "Application endpoint check failed"
          else
            echo "Ingress URL not available"
          fi
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "Health check failed! Manual intervention may be required."
          # Add Slack/Discord webhook notification here if needed
